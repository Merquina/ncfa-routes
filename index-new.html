<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="format-detection" content="telephone=no" />
    <title>NCFA Routes</title>

    <!-- Font Awesome Icons -->
    <link
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        rel="stylesheet"
    />

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/app.css?v=5" />
</head>

<body>
    <!-- Sign-in Landing Page -->
    <div id="signInPage" class="container" style="display: block">
        <div class="header" style="background: #28a745; color: white">
            <div style="text-align: center; padding: 20px">
                <h1 style="margin: 0 0 10px 0">
                    North Country Food Alliance
                </h1>
                <div style="font-size: 1.2rem; margin: 10px 0">
                    ðŸ¥• ðŸ¥’ ðŸ¥¬
                </div>
                <p style="margin: 10px 0 20px 0; font-size: 1.1rem">
                    SPFM and Recovery Routes
                </p>
            </div>
        </div>

        <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px;">
            <div style="text-align: center; max-width: 400px">
                <h2 style="margin: 0 0 15px 0; color: #333">Welcome!</h2>
                <p style="margin: 0 0 30px 0; color: #666; line-height: 1.5;">
                    Please sign in with your Google account to access the
                    SPFM Routes application.
                </p>
                <button
                    id="signInButton"
                    onclick="handleSignInClick()"
                    style="
                        background: #4285f4;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 6px;
                        font-size: 1rem;
                        cursor: pointer;
                        font-family: var(--body-font);
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                        transition: background-color 0.2s;
                    "
                    onmouseover="this.style.backgroundColor='#3367d6'"
                    onmouseout="this.style.backgroundColor='#4285f4'"
                >
                    Sign in with Google
                </button>
                <div
                    id="signInStatus"
                    style="margin-top: 20px; color: #666; font-size: 0.9rem"
                ></div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until signed in) -->
    <div id="mainApp" class="container" style="display: none">
        <app-layout>
            <hash-router default-route="/boxes">
                <!-- Routes will be loaded here -->
            </hash-router>
        </app-layout>
    </div>

    <!-- Legacy Application Modules - Still needed for sheets API -->
    <script src="js/sheets.js?v=4" type="text/javascript"></script>
    <script src="js/assignments.js?v=4" type="text/javascript"></script>
    <script src="js/inventory.js?v=4" type="text/javascript"></script>
    <script src="js/workers.js?v=4" type="text/javascript"></script>
    <script src="js/dates.js?v=4" type="text/javascript"></script>
    <script src="js/app.js?v=4" type="text/javascript"></script>

    <!-- New Web Components System -->
    <script src="src/components/index.js?v=6" type="module"></script>

    <!-- SPA Router Setup -->
    <script type="module">
        // Wait for everything to load
        document.addEventListener('DOMContentLoaded', () => {
            const router = document.querySelector('hash-router');
            const appLayout = document.querySelector('app-layout');
            
            if (router && appLayout) {
                // Register routes
                router.registerRoute('/boxes', 'boxes-page', 'Box Inventory');
                router.registerRoute('/workers', 'workers-page', 'Routes by Worker');
                router.registerRoute('/dates', 'dates-page', 'Next 7 Days');
                
                // Listen for route changes to update layout
                router.addEventListener('route-changed', (e) => {
                    if (appLayout.updateActiveTab) {
                        appLayout.updateActiveTab(e.detail.path);
                    }
                });
                
                // Listen for layout events
                appLayout.addEventListener('sign-out', () => {
                    handleSignOutClick();
                });
            }
        });
    </script>

    <!-- Authentication & Legacy Logic -->
    <script>
        // OAuth Configuration
        const DISCOVERY_DOC_AUTH = "https://sheets.googleapis.com/$discovery/rest?version=v4";
        const SCOPES_AUTH = "https://www.googleapis.com/auth/spreadsheets";

        let gapiAuth;
        let googleAuth;
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Initialize Google APIs
        function gapiLoaded() {
            window.gapi.load("client", initializeGapiClient);
        }

        async function initializeGapiClient() {
            await window.gapi.client.init({
                apiKey: "AIzaSyDQhg6nsoV3WE7aqdorOAbb6tobVkw__9s",
                discoveryDocs: [DISCOVERY_DOC_AUTH],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = window.google.accounts.oauth2.initTokenClient({
                client_id: "679707714871-h18m1gdtsdoovh8tjufr8idmr905i5gc.apps.googleusercontent.com",
                scope: SCOPES_AUTH,
                callback: "", // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                checkPersistedSession();
            }
        }

        function updateSignInStatus() {
            if (window.gapi && window.gapi.client && window.gapi.client.getToken() !== null) {
                showMainApp();
            }
        }

        function handleSignInClick() {
            document.getElementById("signInStatus").textContent = "Signing in...";

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    document.getElementById("signInStatus").textContent = "Sign in failed. Please try again.";
                    throw resp;
                }

                // Store token for persistence
                const token = window.gapi.client.getToken();
                if (token) {
                    const expiresAt = new Date();
                    expiresAt.setSeconds(expiresAt.getSeconds() + parseInt(token.expires_in || 3600));

                    const tokenData = {
                        ...token,
                        expires_at: expiresAt.toISOString(),
                    };

                    localStorage.setItem("gapi_token", JSON.stringify(tokenData));
                }

                updateSignInStatus();
                showMainApp();
            };

            tokenClient.requestAccessToken({ prompt: "select_account" });
        }

        function handleSignOutClick() {
            const token = window.gapi.client.getToken();
            if (token !== null) {
                window.google.accounts.oauth2.revoke(token.access_token);
                window.gapi.client.setToken("");
            }

            localStorage.removeItem("gapi_token");
            showSignInPage();
        }

        function showMainApp() {
            document.getElementById("signInPage").style.display = "none";
            document.getElementById("mainApp").style.display = "flex";
        }

        function showSignInPage() {
            document.getElementById("signInPage").style.display = "flex";
            document.getElementById("mainApp").style.display = "none";
            document.getElementById("signInStatus").textContent = "";
        }

        function checkPersistedSession() {
            if (window.gapi && window.gapi.client) {
                const token = window.gapi.client.getToken();
                if (token && token.access_token) {
                    console.log("âœ… Found existing OAuth session");
                    showMainApp();
                    return;
                }
            }

            const storedToken = localStorage.getItem("gapi_token");
            if (storedToken) {
                try {
                    const tokenData = JSON.parse(storedToken);
                    if (tokenData.access_token && new Date(tokenData.expires_at) > new Date()) {
                        window.gapi.client.setToken(tokenData);
                        console.log("âœ… Restored OAuth session from storage");
                        showMainApp();
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem("gapi_token");
                }
            }

            console.log("No valid OAuth session found");
        }

        // Initialize APIs when page loads
        window.onload = function () {
            gapiLoaded();
            gisLoaded();
        };
    </script>
</body>
</html>