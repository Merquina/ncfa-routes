<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Market Recovery Routes</title>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />

        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                margin: 0;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
                padding: 20px;
                text-align: left;
                color: white;
            }

            .header h1 {
                font-size: 2.2rem;
                font-weight: 300;
                margin: 0 0 8px 0;
            }

            .header p {
                font-size: 1rem;
                opacity: 0.9;
                margin: 0 0 15px 0;
            }

            .section-title {
                font-size: 1.5rem;
                color: #333;
                font-weight: 600;
                margin-bottom: 20px;
            }

            .worker-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 10px;
            }

            .worker-card {
                background: #f8f9fa;
                border-radius: 12px;
                padding: 15px;
                text-align: left;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid #ddd;
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
                font-weight: 600;
                font-size: 1rem;
            }

            .worker-card:hover {
                border-color: #56ab2f;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px);
            }

            .worker-card.selected {
                background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
                color: white;
                border-color: #56ab2f;
                box-shadow: 0 8px 16px rgba(86, 171, 47, 0.3);
                transform: translateY(-3px);
            }

            .assignment-card {
                margin-top: 20px;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            }

            .market-section,
            .dropoff-section,
            .final-section {
                padding: 20px;
                color: white;
            }

            .market-section {
                background: linear-gradient(135deg, #87ceeb 0%, #b8d4f0 100%);
            }

            .dropoff-section {
                background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            }

            .final-section {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                text-align: left;
            }

            .task-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                padding: 20px;
                background: white;
            }

            .task-column {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
            }

            .task-header {
                font-size: 1.1rem;
                font-weight: 600;
                color: #333;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 2px solid #e9ecef;
            }

            .task-item {
                display: flex;
                align-items: center;
                margin-bottom: 6px;
                padding: 6px;
                border-radius: 4px;
                transition: background-color 0.2s;
            }

            .task-item:hover {
                background-color: #e9ecef;
            }

            .task-checkbox {
                width: 20px;
                height: 20px;
                border: 2px solid #56ab2f;
                border-radius: 4px;
                margin-right: 10px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .task-checkbox.checked {
                background-color: #56ab2f;
                position: relative;
            }

            .task-checkbox.checked::after {
                content: "‚úì";
                color: white;
                font-size: 14px;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .task-text {
                flex: 1;
                color: #333;
            }

            .team-info {
                padding: 20px;
                background: #f8f9fa;
                border-top: 1px solid #e9ecef;
            }

            .team-info h3 {
                color: #333;
                margin-bottom: 10px;
                font-size: 1.1rem;
            }

            .team-info-header {
                display: flex;
                justify-content: flex-start;
                align-items: flex-start;
                margin-top: 15px;
                flex-wrap: wrap;
                gap: 30px;
            }

            .team-info-header h3 {
                color: white;
                margin-bottom: 10px;
                font-size: 1.1rem;
            }

            .flow-section {
                background: white;
            }

            .step-section {
                padding: 20px;
                border-bottom: 1px solid #e9ecef;
            }

            .step-section:last-child {
                border-bottom: none;
            }

            .step-header {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
                gap: 12px;
            }

            .step-number {
                background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 1.2rem;
            }

            .step-header h3 {
                color: #333;
                margin: 0;
                font-size: 1.3rem;
            }

            .single-column {
                max-width: none;
            }

            .flow-arrow {
                text-align: center;
                font-size: 1.5rem;
                padding: 10px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                color: #56ab2f;
            }

            .team-member {
                display: inline-block;
                background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                margin-right: 10px;
                font-weight: 500;
            }

            .van-badge {
                display: inline-block;
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                margin-right: 10px;
                font-weight: 500;
            }

            .no-assignments {
                padding: 30px;
                text-align: left;
                color: #666;
                font-size: 1rem;
            }

            @media (max-width: 768px) {
                .task-grid {
                    grid-template-columns: 1fr;
                }

                .header h1 {
                    font-size: 2rem;
                }

                .container {
                    margin: 10px;
                    border-radius: 15px;
                }

                .team-info-header {
                    flex-direction: column;
                }

                .step-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 10px;
                }
            }

            .view-toggle {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                justify-content: flex-start;
            }

            .view-btn {
                background: #f8f9fa;
                border: 2px solid #ddd;
                padding: 12px 24px;
                border-radius: 25px;
                cursor: pointer;
                font-weight: 600;
                font-size: 1rem;
                transition: all 0.3s ease;
            }

            .view-btn:hover {
                border-color: #56ab2f;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .view-btn.active {
                background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
                color: white;
                border-color: #56ab2f;
                box-shadow: 0 4px 12px rgba(86, 171, 47, 0.3);
            }

            .date-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 15px;
                padding: 0 15px;
            }

            .date-card {
                background: #f8f9fa;
                border-radius: 12px;
                padding: 15px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid #ddd;
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            }

            .date-card:hover {
                border-color: #56ab2f;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px);
            }

            .date-card.selected {
                background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
                color: white;
                border-color: #56ab2f;
                box-shadow: 0 8px 16px rgba(86, 171, 47, 0.3);
                transform: translateY(-3px);
            }

            .date-card h3 {
                margin: 0 0 10px 0;
                font-size: 1.3rem;
            }

            .date-card .markets {
                font-size: 0.9rem;
                opacity: 0.8;
            }

            .date-card.selected .markets {
                opacity: 1;
            }

            .directions-btn {
                background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
                margin-left: 10px;
                transition: all 0.2s ease;
                text-decoration: none;
                display: inline-block;
            }

            .directions-btn:hover {
                box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
                transform: translateY(-1px);
            }

            .print-btn {
                background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
                margin-left: 10px;
                transition: all 0.2s ease;
                text-decoration: none;
                display: inline-block;
            }

            .print-btn:hover {
                box-shadow: 0 2px 8px rgba(108, 92, 231, 0.3);
                transform: translateY(-1px);
            }

            @media print {
                @page {
                    size: letter;
                    margin: 0.3in;
                }

                body {
                    background: white !important;
                    font-size: 9px;
                    line-height: 1.2;
                    margin: 0;
                    padding: 0;
                    height: 100vh;
                    overflow: hidden;
                    transform: scale(0.95);
                    transform-origin: top left;
                    text-align: left;
                }

                .container {
                    background: white !important;
                    box-shadow: none !important;
                    border-radius: 0 !important;
                    margin: 0 !important;
                    max-width: none !important;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                }

                .header {
                    background: #f0f0f0 !important;
                    color: black !important;
                    padding: 6px !important;
                    flex-shrink: 0;
                    text-align: left !important;
                }

                .header h1 {
                    font-size: 14px !important;
                    margin: 0 !important;
                    text-align: left !important;
                }

                .header p {
                    font-size: 9px !important;
                    margin: 1px 0 !important;
                    text-align: left !important;
                }

                .view-toggle,
                .worker-grid,
                .date-grid,
                #inventoryBox {
                    display: none !important;
                }

                #assignmentContainer {
                    flex: 1;
                    overflow: hidden;
                }

                .assignment-card {
                    margin: 0 !important;
                    page-break-inside: avoid;
                    box-shadow: none !important;
                    border: 1px solid #ccc !important;
                    height: calc(100vh - 60px);
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                }

                .step-section + .step-section {
                    margin-top: 0 !important;
                }

                .flow-section .step-section:not(:first-child) {
                    border-top: none !important;
                }

                .market-section {
                    background: #f5f5f5 !important;
                    color: black !important;
                    padding: 6px !important;
                    flex-shrink: 0;
                    text-align: left !important;
                }

                .market-section h2 {
                    font-size: 12px !important;
                    margin: 0 0 3px 0 !important;
                    text-align: left !important;
                }

                .market-section p {
                    margin: 1px 0 !important;
                    font-size: 8px !important;
                    text-align: left !important;
                }

                .team-info-header {
                    background: #f0f0f0 !important;
                    color: black !important;
                    padding: 4px !important;
                    font-size: 7px !important;
                    flex-shrink: 0;
                    text-align: left !important;
                }

                .team-info-header h3 {
                    font-size: 8px !important;
                    margin: 0 0 2px 0 !important;
                    text-align: left !important;
                }

                .team-member,
                .van-badge {
                    background: #e0e0e0 !important;
                    color: black !important;
                    border: 1px solid #ccc !important;
                    padding: 2px 6px !important;
                    font-size: 8px !important;
                }

                .flow-section {
                    flex: 1;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    gap: 0 !important;
                }

                .step-section {
                    padding: 2px !important;
                    border-bottom: none !important;
                    flex: 1;
                    overflow: hidden;
                    text-align: left !important;
                    margin: 0 !important;
                }

                .step-header {
                    margin-bottom: 1px !important;
                    text-align: left !important;
                }

                .step-header h3 {
                    font-size: 9px !important;
                    margin: 0 !important;
                    text-align: left !important;
                }

                .step-number {
                    width: 20px !important;
                    height: 20px !important;
                    font-size: 8px !important;
                }

                .task-grid {
                    grid-template-columns: 1fr 1fr !important;
                    gap: 2px !important;
                    height: calc(100% - 20px);
                    overflow: hidden;
                }

                .task-column {
                    background: #f9f9f9 !important;
                    padding: 2px !important;
                    overflow: hidden;
                    text-align: left !important;
                }

                .task-header {
                    font-size: 8px !important;
                    margin-bottom: 1px !important;
                    padding-bottom: 0px !important;
                    text-align: left !important;
                }

                .task-item {
                    margin-bottom: 0px !important;
                    padding: 0px !important;
                    font-size: 7px !important;
                    text-align: left !important;
                }

                .task-checkbox {
                    width: 12px !important;
                    height: 12px !important;
                    margin-right: 4px !important;
                }

                .single-column {
                    max-width: none;
                    height: calc(100% - 15px);
                    overflow: hidden;
                    text-align: left !important;
                }

                .directions-btn,
                .print-btn {
                    display: none !important;
                }

                .flow-arrow {
                    font-size: 6px !important;
                    padding: 0px !important;
                    flex-shrink: 0;
                    text-align: center !important;
                    margin: 0 !important;
                    line-height: 1 !important;
                }
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="header">
                <h1>üßë‚Äçüåæ SPFM and Recovery Routes ü•ïü•íü•¨</h1>
                <p>
                    Click a worker to see their next assignment or view by date
                </p>
                <div
                    style="
                        margin-top: 15px;
                        display: flex;
                        gap: 15px;
                        justify-content: center;
                        align-items: center;
                    "
                >
                    <a
                        href="https://docs.google.com/spreadsheets/d/1yn3yPWW5ThhPvHzYiSkwwNztVnAQLD2Rk_QEQJwlr2k/edit?usp=sharing"
                        target="_blank"
                        style="
                            color: rgba(255, 255, 255, 0.8);
                            text-decoration: none;
                            font-size: 0.9rem;
                            padding: 8px 16px;
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            border-radius: 20px;
                            transition: all 0.2s ease;
                        "
                        onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'; this.style.color='white';"
                        onmouseout="this.style.backgroundColor='transparent'; this.style.color='rgba(255,255,255,0.8)';"
                    >
                        üîß Backend Access (Editors Only)
                    </a>
                    <button
                        id="authButton"
                        style="
                            color: rgba(255, 255, 255, 0.8);
                            background: transparent;
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            font-size: 0.9rem;
                            padding: 8px 16px;
                            border-radius: 20px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        "
                        onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'; this.style.color='white';"
                        onmouseout="this.style.backgroundColor='transparent'; this.style.color='rgba(255,255,255,0.8)';"
                    >
                        üîê Sign In with Google
                    </button>
                    <div
                        id="authStatus"
                        style="
                            font-size: 0.8rem;
                            color: rgba(255, 255, 255, 0.7);
                            margin-top: 5px;
                        "
                    >
                        Sign in to save your progress
                    </div>
                    <button
                        onclick="printAssignment()"
                        style="
                            color: rgba(255, 255, 255, 0.8);
                            background: transparent;
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            font-size: 0.9rem;
                            padding: 8px 16px;
                            border-radius: 20px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        "
                        onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'; this.style.color='white';"
                        onmouseout="this.style.backgroundColor='transparent'; this.style.color='rgba(255,255,255,0.8)';"
                    >
                        üñ®Ô∏è Print/PDF
                    </button>
                </div>
            </div>
            <div style="padding: 15px">
                <div
                    id="inventoryBox"
                    <div style="margin-bottom: 15px; display: none">
                >
                    <div
                        style="
                            background: linear-gradient(
                                135deg,
                                #4facfe 0%,
                                #00f2fe 100%
                            );
                            color: white;
                            padding: 20px;
                            border-radius: 15px;
                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                        "
                    >
                        <h3
                            style="
                                margin: 0 0 15px 0;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            "
                        >
                            üì¶ Current Box Inventory
                        </h3>
                        <div
                            id="inventoryContent"
                            style="
                                display: grid;
                                grid-template-columns: repeat(
                                    auto-fit,
                                    minmax(200px, 1fr)
                                );
                                gap: 15px;
                            "
                        >
                            <!-- Inventory items will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="view-toggle">
                    <button id="workerViewBtn" class="view-btn active">
                        üë• By Worker
                    </button>
                    <button id="dateViewBtn" class="view-btn">
                        üìÖ By Date
                    </button>
                </div>
                <div class="section-title" id="sectionTitle">Workers</div>
            </div>
            <div class="worker-grid" id="workerGrid"></div>
            <div class="date-grid" id="dateGrid" style="display: none"></div>
            <div id="assignmentContainer"></div>
        </div>

        <script>
            /*
             * ========================================
             * SPFM ROUTES DASHBOARD
             * ========================================
             * This is a visual-only interface for viewing Google Sheets data.
             * No data is saved - it's just a prettier way to view spreadsheet info.
             * Data flows: User's Browser ‚Üî Google Sheets API ‚Üî Spreadsheet
             */

            // ========================================
            // GOOGLE SHEETS API CONFIGURATION
            // ========================================
            // These connect directly to Google's servers - no middleman
            const SHEET_ID = "1yn3yPWW5ThhPvHzYiSkwwNztVnAQLD2Rk_QEQJwlr2k"; // The spreadsheet ID from the URL
            const CLIENT_ID =
                "679707714871-h18m1gdtsdoovh8tjufr8idmr905i5gc.apps.googleusercontent.com"; // Google OAuth app ID
            const API_KEY = "AIzaSyDQhg6nsoV3WE7aqdorOAbb6tobVkw__9s"; // Public API key for reading sheets
            const RANGE = "A:Z"; // Read all columns from the sheet

            // ========================================
            // OAUTH CONFIGURATION (FOR FUTURE FEATURES)
            // ========================================
            // Currently used for authentication UI only - no data is actually saved
            const DISCOVERY_DOC =
                "https://sheets.googleapis.com/$discovery/rest?version=v4";
            const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

            // ========================================
            // GLOBAL VARIABLES
            // ========================================
            let tokenClient; // Handles Google sign-in
            let isAuthorized = false; // Track if user is signed in (for UI only)

            let data = []; // Main spreadsheet data - routes, workers, assignments
            let recoveryData = []; // Recovery routes data from Recovery sheet tab
            let inventoryData = []; // Box inventory data from separate sheet tab
            let currentView = "worker"; // Track which view is active: 'worker' or 'date'

            // ========================================
            // UI CUSTOMIZATION
            // ========================================
            // Fun emojis to make the interface more friendly and recognizable
            const workerIcons = {
                Samuel: "üêã",
                Emmanuel: "ü¶Å",
                Irmydel: "üê∏",
                Tess: "üåü",
                Ayoyo: "‚ö°",
                Rosey: "üåπ",
                Boniat: "üåä",
                // Volunteers get a generic person emoji
                Volunteer: "üë§",
            };

            const vanIcons = {
                "Green Bean": "ü´õ",
                Tooth: "ü¶∑",
                Marshmallow: "üç°",
            };

            // ========================================
            // DOM ELEMENT REFERENCES
            // ========================================
            // Get references to main UI containers for easy manipulation
            const workerGrid = document.getElementById("workerGrid");
            const assignmentContainer = document.getElementById(
                "assignmentContainer",
            );

            // ========================================
            // GOOGLE API INITIALIZATION
            // ========================================
            // These functions are called automatically when Google's scripts load

            // Called when the main Google API script finishes loading
            function gapiLoaded() {
                console.log("‚úÖ Google API loaded");
                gapi.load("client", initializeGapiClient); // Load the Sheets API client
            }

            // Set up the Google Sheets API client with our credentials
            async function initializeGapiClient() {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY, // Public key for reading data
                        discoveryDocs: [DISCOVERY_DOC], // API documentation
                    });
                    console.log("‚úÖ Google API client initialized");
                } catch (error) {
                    console.error(
                        "‚ùå Error initializing Google API client:",
                        error,
                    );
                }
            }

            // ========================================
            // GOOGLE SIGN-IN INITIALIZATION
            // ========================================
            // Called when Google's sign-in script finishes loading

            function gsiLoaded() {
                console.log("‚úÖ Google Sign-In loaded");
                // Set up the sign-in client (for UI purposes - no actual data saving)
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        console.log("‚úÖ OAuth token received:", tokenResponse);
                        if (tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse);
                            isAuthorized = true;
                            console.log("‚úÖ User authorized");
                            // Save session locally (just for this browser session)
                            saveOAuthSession(tokenResponse);
                        } else {
                            console.log("‚ùå No access token received");
                            isAuthorized = false;
                        }
                        updateAuthUI(); // Update the sign-in button appearance
                    },
                    error_callback: (error) => {
                        console.error("‚ùå OAuth error:", error);
                        isAuthorized = false;
                        updateAuthUI();
                    },
                });
                console.log("‚úÖ Google Sign-In client initialized");
            }

            function initializeGsi() {
                console.log("üîÑ Initializing Google Sign-In...");
                if (
                    typeof window.google === "undefined" ||
                    !window.google.accounts
                ) {
                    console.error("‚ùå Google Sign-In library not loaded");
                    return;
                }

                try {
                    tokenClient = window.google.accounts.oauth2.initTokenClient(
                        {
                            client_id: CLIENT_ID,
                            scope: SCOPES,
                            callback: (tokenResponse) => {
                                console.log(
                                    "‚úÖ OAuth token received:",
                                    tokenResponse,
                                );
                                if (tokenResponse.access_token) {
                                    window.gapi.client.setToken(tokenResponse);
                                    isAuthorized = true;
                                    console.log("‚úÖ User authorized");
                                } else {
                                    console.log("‚ùå No access token received");
                                    isAuthorized = false;
                                }
                                updateAuthUI();
                            },
                            error_callback: (error) => {
                                console.error("‚ùå OAuth error:", error);
                                isAuthorized = false;
                                updateAuthUI();
                            },
                        },
                    );
                    console.log("‚úÖ Google Sign-In client initialized");
                } catch (error) {
                    console.error(
                        "‚ùå Error initializing Google Sign-In:",
                        error,
                    );
                }
            }

            // ========================================
            // AUTHENTICATION UI MANAGEMENT
            // ========================================
            // Updates the sign-in button and status text based on auth state

            function updateAuthUI() {
                const authButton = document.getElementById("authButton");
                const authStatus = document.getElementById("authStatus");

                if (isAuthorized) {
                    // User is signed in - hide the auth button
                    authButton.style.display = "none";
                    authStatus.style.display = "none";
                } else {
                    // User is not signed in - show sign in button only
                    authButton.textContent = "üîê Sign In with Google";
                    authButton.onclick = authorize;
                    authButton.style.display = "inline-block";
                    authStatus.style.display = "none";
                }
            }

            // ========================================
            // SIGN-IN FUNCTIONS
            // ========================================
            // Handle user authentication (currently just for UI - no data saving)

            function authorize() {
                console.log("üîê Attempting to authorize...");
                try {
                    if (tokenClient) {
                        console.log("üìù Requesting access token...");
                        // Trigger Google's sign-in popup
                        tokenClient.requestAccessToken({
                            prompt: "consent",
                            hint: "Select your Google account",
                        });
                    } else {
                        console.error("‚ùå Token client not initialized");
                        alert(
                            "Authentication not ready. Please refresh the page and try again.",
                        );
                    }
                } catch (error) {
                    console.error("‚ùå Error during authorization:", error);
                    alert(
                        "Sign-in failed. Please check console for details and try again.",
                    );
                }
            }

            function signOut() {
                try {
                    const token = window.gapi.client.getToken();
                    if (token !== null) {
                        // Revoke the access token with Google
                        window.google.accounts.oauth2.revoke(
                            token.access_token,
                        );
                        window.gapi.client.setToken("");
                    }
                    isAuthorized = false;
                    // Clear any saved session data
                    clearOAuthSession();
                    updateAuthUI();
                    console.log("‚úÖ Signed out successfully");
                } catch (error) {
                    console.error("‚ùå Error during sign out:", error);
                    isAuthorized = false;
                    updateAuthUI();
                }
            }

            // ========================================
            // SESSION MANAGEMENT (BROWSER ONLY)
            // ========================================
            // These functions manage sign-in state in the user's browser only
            // No data is sent to external servers

            function saveOAuthSession(tokenResponse) {
                try {
                    const sessionData = {
                        access_token: tokenResponse.access_token,
                        expires_at:
                            Date.now() + tokenResponse.expires_in * 1000,
                        scope: tokenResponse.scope,
                        token_type: tokenResponse.token_type,
                    };
                    // Save to browser's local storage (stays on user's computer)
                    localStorage.setItem(
                        "oauth_session",
                        JSON.stringify(sessionData),
                    );
                    console.log("‚úÖ OAuth session saved to localStorage");
                } catch (error) {
                    console.error("‚ùå Error saving OAuth session:", error);
                }
            }

            function restoreOAuthSession() {
                try {
                    const sessionData = localStorage.getItem("oauth_session");
                    if (!sessionData) {
                        console.log("No saved OAuth session found");
                        return;
                    }

                    const session = JSON.parse(sessionData);

                    // Check if the saved token is still valid (with 5 minute safety buffer)
                    if (Date.now() > session.expires_at - 300000) {
                        console.log("Saved OAuth session expired");
                        clearOAuthSession();
                        return;
                    }

                    // Token is still good - restore it
                    gapi.client.setToken({
                        access_token: session.access_token,
                    });

                    isAuthorized = true;
                    updateAuthUI();
                    console.log("‚úÖ OAuth session restored from localStorage");
                } catch (error) {
                    console.error("‚ùå Error restoring OAuth session:", error);
                    clearOAuthSession();
                }
            }

            function clearOAuthSession() {
                try {
                    localStorage.removeItem("oauth_session");
                    console.log("‚úÖ OAuth session cleared from localStorage");
                } catch (error) {
                    console.error("‚ùå Error clearing OAuth session:", error);
                }
            }

            // ========================================
            // APPLICATION INITIALIZATION
            // ========================================
            // This runs when the page first loads

            window.onload = async () => {
                console.log("üöÄ Starting SPFM Routes Dashboard...");

                // Set up the authentication UI (starts in "not signed in" state)
                updateAuthUI();

                // After a brief delay, check if user was previously signed in
                setTimeout(() => {
                    if (typeof gapi !== "undefined" && gapi.client) {
                        restoreOAuthSession();
                    }
                }, 2000);

                // Fetch the actual spreadsheet data (this works without signing in)
                try {
                    console.log("üìä Fetching sheet data from Google...");
                    await fetchSheetData();
                    console.log("‚úÖ Data loaded successfully");
                } catch (dataError) {
                    console.error("‚ùå Failed to fetch data:", dataError);
                }
            };

            // ========================================
            // DATA FETCHING FROM GOOGLE SHEETS
            // ========================================
            // This function reads data directly from the Google Spreadsheet
            // No intermediate servers - direct browser-to-Google communication

            async function fetchSheetData() {
                try {
                    // Add timestamp to prevent browser caching old data
                    const timestamp = new Date().getTime();
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/SPFM!A:T?key=${API_KEY}&_=${timestamp}`;
                    console.log("Fetching fresh data from Google Sheets...");

                    // Make the API call directly to Google
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(
                            `HTTP ${response.status}: ${response.statusText}`,
                        );
                    }

                    const result = await response.json();
                    console.log("‚úÖ Raw data received from Google");

                    if (!result.values || result.values.length < 2) {
                        throw new Error("No data found in the spreadsheet");
                    }

                    // Convert spreadsheet rows into JavaScript objects for easier use
                    const headers = result.values[0]; // First row contains column names
                    data = result.values
                        .slice(1) // Skip the header row
                        .filter((row) => row && row.length > 0 && row[0]) // Remove empty rows
                        .map((row) => {
                            // Create an object for each row using headers as keys
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || ""; // Use empty string if cell is blank
                            });
                            return obj;
                        });

                    console.log(
                        `‚úÖ Processed ${data.length} routes from spreadsheet`,
                    );
                    console.log("Sample route data:", data[0]);
                    console.log("Available columns:", headers);

                    // Also fetch recovery routes and box inventory data
                    await fetchRecoveryData();
                    await fetchInventoryData();

                    // Set up the view switching buttons (Worker view vs Date view)
                    document
                        .getElementById("workerViewBtn")
                        .addEventListener("click", () => switchView("worker"));
                    document
                        .getElementById("dateViewBtn")
                        .addEventListener("click", () => switchView("date"));

                    // Start with the worker view displayed
                    switchView("worker");

                    // Log some debug information
                    console.log("Debug summary:");
                    console.log("‚Ä¢ Total routes loaded:", data.length);
                    console.log(
                        "‚Ä¢ Sample route statuses:",
                        data.slice(0, 5).map((d) => d.status),
                    );
                } catch (error) {
                    console.error("‚ùå Google Sheets API Error:", error);
                    // Show user-friendly error message if data loading fails
                    document.getElementById("workerGrid").innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; color: red; padding: 40px;">
                            <h3>‚ö†Ô∏è Error Loading Data</h3>
                            <p><strong>Connection Issue:</strong></p>
                            <p>1. Make sure the spreadsheet is set to "Anyone with the link can view"</p>
                            <p>2. Check your internet connection</p>
                            <p><strong>Technical Error:</strong> ${error.message}</p>
                            <br>
                            <p>Contact admin if this continues.</p>
                        </div>
                    `;
                }
            }

            // ========================================
            // WORKER VIEW RENDERING
            // ========================================
            // Creates clickable cards for each worker found in the spreadsheet

            function renderWorkers() {
                // Find all unique worker names from the spreadsheet data
                const workerSet = new Set();

                // Get workers from SPFM data
                data.forEach((route) => {
                    // Each route can have up to 3 workers assigned
                    [route.worker1, route.worker2, route.worker3].forEach(
                        (worker) => {
                            if (worker && typeof worker === "string") {
                                const normalized = worker.trim();
                                // Skip empty entries and cancelled routes
                                if (
                                    normalized !== "" &&
                                    normalized.toUpperCase() !== "CANCELLED"
                                ) {
                                    workerSet.add(normalized);
                                }
                            }
                        },
                    );
                });

                // Also get workers from Recovery data (including volunteers)
                recoveryData.forEach((route) => {
                    const worker = route.Worker;
                    if (worker && typeof worker === "string") {
                        const normalized = worker.trim();
                        if (
                            normalized !== "" &&
                            normalized.toLowerCase() !== "worker"
                        ) {
                            workerSet.add(normalized);
                        }
                    }
                });

                const workers = [...workerSet].sort(); // Convert to array and sort alphabetically

                workerGrid.innerHTML = ""; // Clear any existing worker cards

                // Create a clickable card for each worker
                workers.forEach((worker) => {
                    const div = document.createElement("div");
                    div.className = "worker-card";

                    // Find matching emoji for this worker (case-insensitive)
                    const workerIcon = Object.keys(workerIcons).find(
                        (key) => key.toLowerCase() === worker.toLowerCase(),
                    );
                    const emoji = workerIcon ? workerIcons[workerIcon] : "üë§"; // Default person emoji

                    div.innerHTML = `${emoji} ${worker}`;
                    div.onclick = () => {
                        selectWorker(worker, div);
                        // Smooth scroll to assignment container
                        setTimeout(() => {
                            document
                                .getElementById("assignmentContainer")
                                .scrollIntoView({
                                    behavior: "smooth",
                                    block: "start",
                                });
                        }, 100);
                    };
                    workerGrid.appendChild(div);
                });
            }

            // ========================================
            // DATE VIEW RENDERING
            // ========================================
            // Creates clickable cards for upcoming dates with their routes

            function renderDates() {
                const dateGrid = document.getElementById("dateGrid");
                dateGrid.innerHTML = ""; // Clear existing dates

                // Create SPFM section
                const spfmSection = document.createElement("div");
                spfmSection.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #56ab2f; font-size: 1.4rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            ü•ï <span>SPFM Market Routes</span>
                        </h2>
                        <div id="spfmDates" class="date-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        </div>
                    </div>
                `;
                dateGrid.appendChild(spfmSection);

                // Create Recovery section
                const recoverySection = document.createElement("div");
                recoverySection.innerHTML = `
                    <div>
                        <h2 style="color: #ff6b6b; font-size: 1.4rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            üöó <span>Recovery Routes</span>
                        </h2>
                        <div id="recoveryDates" class="date-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        </div>
                    </div>
                `;
                dateGrid.appendChild(recoverySection);

                // Process SPFM routes
                const upcomingRoutes = data.filter((route) => {
                    if (!route.routeId || !route.date || !route.market) {
                        return false;
                    }
                    const status = route.status || "";
                    return status.trim().toLowerCase() !== "completed";
                });

                const dateGroups = {};
                upcomingRoutes.forEach((route) => {
                    const date = route.date;
                    if (date && date.trim()) {
                        if (!dateGroups[date]) {
                            dateGroups[date] = [];
                        }
                        dateGroups[date].push(route);
                    }
                });

                const sortedDates = Object.keys(dateGroups)
                    .filter((date) => date && date.trim())
                    .sort((a, b) => new Date(a) - new Date(b))
                    .slice(0, 4);

                const spfmContainer = document.getElementById("spfmDates");
                if (sortedDates.length === 0) {
                    spfmContainer.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">
                            <p>No upcoming SPFM routes</p>
                        </div>
                    `;
                } else {
                    sortedDates.forEach((date) => {
                        const routes = dateGroups[date];
                        const markets = routes
                            .map((r) => r.market)
                            .filter(Boolean)
                            .join(", ");

                        // Get worker names for this date
                        const workers = routes
                            .flatMap((r) => [r.worker1, r.worker2, r.worker3])
                            .filter(Boolean)
                            .filter((w) => w.toLowerCase() !== "cancelled")
                            .map((w) => `${getWorkerEmoji(w)} ${w}`)
                            .join(", ");

                        const div = document.createElement("div");
                        div.className = "date-card";
                        div.innerHTML = `
                            <h3>üìÖ ${date}</h3>
                            <div class="markets"><strong>Markets:</strong> ${markets || "No markets"}</div>
                            ${workers ? `<div class="markets"><strong>Workers:</strong> ${workers}</div>` : ""}
                            <div style="margin-top: 10px; font-size: 0.8rem;">
                                ${routes.length} route${routes.length > 1 ? "s" : ""}
                            </div>
                        `;
                        div.onclick = () => {
                            selectDate(date, div);
                            // Smooth scroll to assignment container
                            setTimeout(() => {
                                document
                                    .getElementById("assignmentContainer")
                                    .scrollIntoView({
                                        behavior: "smooth",
                                        block: "start",
                                    });
                            }, 100);
                        };
                        spfmContainer.appendChild(div);
                    });
                }

                // Process Recovery routes
                const recoveryContainer =
                    document.getElementById("recoveryDates");
                if (recoveryData.length === 0) {
                    recoveryContainer.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">
                            <p>No recovery routes available</p>
                        </div>
                    `;
                } else {
                    // Get next 4 recovery route dates
                    const today = new Date();
                    const recoveryRoutes = recoveryData
                        .filter(
                            (route) =>
                                route["Recovery Routes"] &&
                                route.Worker &&
                                route.Worker.toLowerCase() !== "worker",
                        )
                        .map((route) => {
                            const dayName = route["Recovery Routes"];
                            const nextDate = getNextDateForDay(dayName);
                            return {
                                ...route,
                                calculatedDate: nextDate,
                                sortDate: getNextDateObjectForDay(dayName),
                            };
                        })
                        .filter((route) => route.sortDate)
                        .sort((a, b) => a.sortDate - b.sortDate)
                        .slice(0, 4);

                    recoveryRoutes.forEach((route) => {
                        const div = document.createElement("div");
                        div.className = "date-card";
                        div.innerHTML = `
                            <h3>üöó ${route.calculatedDate}</h3>
                            <div class="markets"><strong>Worker:</strong> ${getWorkerEmoji(route.Worker)} ${route.Worker}</div>
                            <div style="margin-top: 10px; font-size: 0.8rem;">
                                Recovery route
                            </div>
                        `;
                        div.onclick = () => {
                            selectRecoveryRoute(route, div);
                            // Smooth scroll to assignment container
                            setTimeout(() => {
                                document
                                    .getElementById("assignmentContainer")
                                    .scrollIntoView({
                                        behavior: "smooth",
                                        block: "start",
                                    });
                            }, 100);
                        };
                        recoveryContainer.appendChild(div);
                    });
                }
            }

            // ========================================
            // VIEW SWITCHING (WORKER vs DATE)
            // ========================================
            // Toggles between showing workers or upcoming dates

            function switchView(viewType) {
                currentView = viewType; // Remember which view is active

                // Update button appearance (highlight the active view)
                document
                    .getElementById("workerViewBtn")
                    .classList.toggle("active", viewType === "worker");
                document
                    .getElementById("dateViewBtn")
                    .classList.toggle("active", viewType === "date");

                // Change the section title
                document.getElementById("sectionTitle").textContent =
                    viewType === "worker" ? "Workers" : "Upcoming Dates";

                // Show/hide the appropriate grid
                document.getElementById("workerGrid").style.display =
                    viewType === "worker" ? "grid" : "none";
                document.getElementById("dateGrid").style.display =
                    viewType === "date" ? "grid" : "none";

                // Clear any previously displayed assignments
                document.getElementById("assignmentContainer").innerHTML = "";

                // Render the appropriate view content
                if (viewType === "worker") {
                    renderWorkers(); // Show worker cards
                } else {
                    renderDates(); // Show date cards
                }
            }

            // ========================================
            // DATE SELECTION HANDLER
            // ========================================
            // Shows all routes/assignments for a selected date

            function selectDate(selectedDate, el) {
                // Update visual selection (highlight clicked date card)
                document
                    .querySelectorAll(".date-card")
                    .forEach((card) => card.classList.remove("selected"));
                el.classList.add("selected");

                // Find all routes scheduled for this specific date
                const routesForDate = data.filter(
                    (route) => route.date === selectedDate,
                );
                const assignmentContainer = document.getElementById(
                    "assignmentContainer",
                );
                assignmentContainer.innerHTML = ""; // Clear previous content

                // Create a detailed assignment card for each route on this date
                routesForDate.forEach((assignment, index) => {
                    const card = document.createElement("div");
                    card.className = "assignment-card";
                    card.style.marginTop = index > 0 ? "20px" : "30px";

                    // If multiple routes on same date, add a header to distinguish them
                    const marketHeader =
                        routesForDate.length > 1
                            ? `<div style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1rem;">
                             üìç Market ${index + 1} of ${routesForDate.length}
                           </div>`
                            : "";

                    card.innerHTML = `
                      ${marketHeader}
              <div class="market-section">
                <h2>${assignment.market} ‚Äì ${assignment.date}</h2>
                <p><strong>Time:</strong> ${assignment.startTime} ‚Äì ${assignment.endTime}</p>
                <p><strong>Pickup Amount:</strong> ${assignment.pickupAmount || assignment["pickupAmount "] || "TBD"}</p>
                <p><strong>Address:</strong> ${assignment.marketAddress}
                  <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(assignment.marketAddress)}"
                     target="_blank" class="directions-btn">üìç Get Directions</a>
                </p>
                ${
                    assignment.dropOffAddress &&
                    assignment.dropOffAddress.trim() !== "" &&
                    assignment.dropOffAddress.trim().toUpperCase() !== "TBD"
                        ? `
                    <p><strong>Full Route:</strong>
                        <a href="https://www.google.com/maps/dir/${encodeURIComponent(assignment.marketAddress)}/${encodeURIComponent(assignment.dropOffAddress.trim())}"
                           target="_blank" class="directions-btn">üó∫Ô∏è Market to Drop-off Route</a>
                    </p>
                `
                        : ""
                }

                <div class="team-info-header">
                  <div>
                    <h3>üë• Team</h3>
                    ${assignment.worker1 ? `<span class="team-member">${getWorkerEmoji(assignment.worker1)} ${assignment.worker1}</span>` : ""}
                    ${assignment.worker2 ? `<span class="team-member">${getWorkerEmoji(assignment.worker2)} ${assignment.worker2}</span>` : ""}
                    ${assignment.worker3 ? `<span class="team-member">${getWorkerEmoji(assignment.worker3)} ${assignment.worker3}</span>` : ""}
                  </div>
                  <div>
                    <h3>üöê Vans</h3>
                    ${assignment.van1 ? `<span class="van-badge">${vanIcons[assignment.van1]} ${assignment.van1}</span>` : ""}
                    ${assignment.van2 ? `<span class="van-badge">${vanIcons[assignment.van2]} ${assignment.van2}</span>` : ""}
                    ${assignment.van3 ? `<span class="van-badge">${vanIcons[assignment.van3]} ${assignment.van3}</span>` : ""}
                  </div>
                </div>
              </div>

              <div class="flow-section">
                <div class="step-section">
                  <div class="step-header">
                    <span class="step-number">1</span>
                    <h3>üì¶ Materials</h3>
                  </div>
                  <div class="task-grid">
                    <div class="task-column">
                      <div class="task-header">üìÇ Office Materials</div>
                      ${assignment.materials_office
                          .split(",")
                          .map((item) => item.trim())
                          .sort()
                          .map(
                              (item) => `
                        <div class="task-item"><div class="task-checkbox"></div><div class="task-text">${item}</div></div>
                      `,
                          )
                          .join("")}
                    </div>
                    <div class="task-column">
                      <div class="task-header">üèïÔ∏è Storage Materials</div>
                      ${assignment.materials_storage
                          .split(",")
                          .map((item) => item.trim())
                          .sort()
                          .map(
                              (item) => `
                        <div class="task-item"><div class="task-checkbox"></div><div class="task-text">${item}</div></div>
                      `,
                          )
                          .join("")}
                    </div>
                  </div>
                </div>

                <div class="flow-arrow">‚¨áÔ∏è</div>

                <div class="step-section">
                  <div class="step-header">
                    <span class="step-number">2</span>
                    <h3>üè™ At Market</h3>
                  </div>
                  <div class="single-column">
                    ${assignment.atMarket
                        .split(",")
                        .map((item) => item.trim())
                        .map(
                            (item) => `
                      <div class="task-item"><div class="task-checkbox"></div><div class="task-text">${item}</div></div>
                    `,
                        )
                        .join("")}
                  </div>
                </div>

                <div class="flow-arrow">‚¨áÔ∏è</div>

                <div class="step-section">
                  <div class="step-header">
                    <span class="step-number">3</span>
                    <h3>üöö Drop-off</h3>
                  </div>
                  <div class="single-column">
                    ${
                        assignment.dropOff &&
                        assignment.dropOff.trim() &&
                        assignment.dropOff !== "TBD"
                            ? `<p><strong>${assignment.dropOff}</strong></p>
                       <p><strong>Address:</strong> ${assignment.dropOffAddress}
                         ${
                             assignment.dropOffAddress &&
                             assignment.dropOffAddress.trim() !== "" &&
                             assignment.dropOffAddress.trim() !== "TBD"
                                 ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(assignment.dropOffAddress.trim())}"
                              target="_blank" class="directions-btn">üìç Get Directions</a>`
                                 : ""
                         }
                       </p>`
                            : "<p><strong>Drop-off location TBD</strong></p>"
                    }
                  </div>
                </div>

                <div class="flow-arrow">‚¨áÔ∏è</div>

                <div class="step-section">
                  <div class="step-header">
                    <span class="step-number">4</span>
                    <h3>üè¢ Back at Office</h3>
                  </div>
                  <div class="single-column">
                    ${assignment.backAtOffice
                        .split(",")
                        .map((item) => item.trim())
                        .map(
                            (item) => `
                      <div class="task-item"><div class="task-checkbox"></div><div class="task-text">${item}</div></div>
                    `,
                        )
                        .join("")}
                  </div>
                </div>
              </div>
            `;
                    card.dataset.routeId = assignment.routeId;
                    assignmentContainer.appendChild(card);
                });

                // Make checkboxes interactive (visual only - no saving)
                document.querySelectorAll(".task-checkbox").forEach((box) => {
                    box.addEventListener("click", () => {
                        // Simply toggle the visual state (checkmark appears/disappears)
                        box.classList.toggle("checked");

                        // Log for debugging (no actual saving occurs)
                        const taskText =
                            box.nextElementSibling?.textContent?.trim();
                        console.log(`‚úì Checkbox toggled: ${taskText}`);
                    });
                });
            }

            // ========================================
            // WORKER SELECTION HANDLER
            // ========================================
            // Shows the next assignment for a selected worker

            function selectWorker(worker, el) {
                // Update visual selection (highlight clicked worker card)
                document
                    .querySelectorAll(".worker-card")
                    .forEach((card) => card.classList.remove("selected"));
                el.classList.add("selected");

                // Find all assignments where this worker is involved
                const allAssignments = data.filter((route) => {
                    const normalizedWorker = worker.trim().toLowerCase();
                    const worker1 = (route.worker1 || "").trim().toLowerCase();
                    const worker2 = (route.worker2 || "").trim().toLowerCase();
                    const worker3 = (route.worker3 || "").trim().toLowerCase();
                    // Check if worker appears in any of the three worker slots
                    return (
                        worker1 === normalizedWorker ||
                        worker2 === normalizedWorker ||
                        worker3 === normalizedWorker
                    );
                });

                console.log(`üîç Finding assignments for ${worker}:`);
                console.log(`Found ${allAssignments.length} total assignments`);
                allAssignments.forEach((assignment, i) => {
                    console.log(
                        `  ${i + 1}: ${assignment.routeId} - ${assignment.date} - ${assignment.market} - Status: "${assignment.status}"`,
                    );
                });

                // Filter to only upcoming (non-completed) assignments
                const upcomingAssignments = allAssignments.filter(
                    (assignment) => {
                        // Skip assignments missing essential data
                        if (
                            !assignment.routeId ||
                            !assignment.date ||
                            !assignment.market
                        ) {
                            return false;
                        }
                        // Only show assignments that haven't been completed yet
                        const status = assignment.status || "";
                        return status.trim().toLowerCase() !== "completed";
                    },
                );

                console.log(
                    `üìã ${upcomingAssignments.length} upcoming assignments for ${worker}:`,
                );
                upcomingAssignments.forEach((assignment, i) => {
                    console.log(
                        `  ${i + 1}: ${assignment.routeId} - ${assignment.date} - ${assignment.market}`,
                    );
                });

                // Sort by date chronologically and show only the very next assignment
                const nextSpfmAssignment = upcomingAssignments
                    .sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateA - dateB; // Earliest date first
                    })
                    .slice(0, 1); // Take only the first (next) assignment

                // Find recovery routes for this worker
                const nextRecoveryRoute = recoveryData
                    .filter((route) => {
                        const routeWorker = (route.Worker || "")
                            .trim()
                            .toLowerCase();
                        const normalizedWorker = worker.trim().toLowerCase();
                        return (
                            routeWorker === normalizedWorker &&
                            route["Recovery Routes"] &&
                            route["Recovery Routes"].trim().toLowerCase() !==
                                "worker"
                        );
                    })
                    .slice(0, 1); // Take only first recovery route

                console.log("üéØ Next assignments selected:");
                if (nextSpfmAssignment.length > 0) {
                    console.log(
                        `  ‚Üí SPFM: ${nextSpfmAssignment[0].routeId} - ${nextSpfmAssignment[0].date} - ${nextSpfmAssignment[0].market}`,
                    );
                }
                if (nextRecoveryRoute.length > 0) {
                    console.log(
                        `  ‚Üí Recovery: ${nextRecoveryRoute[0]["Recovery Routes"]} route`,
                    );
                }
                if (
                    nextSpfmAssignment.length === 0 &&
                    nextRecoveryRoute.length === 0
                ) {
                    console.log("  ‚Üí No upcoming assignments found");
                }

                const assignmentContainer = document.getElementById(
                    "assignmentContainer",
                );
                assignmentContainer.innerHTML = ""; // Clear previous content

                // Show message if no upcoming work found
                if (
                    nextSpfmAssignment.length === 0 &&
                    nextRecoveryRoute.length === 0
                ) {
                    assignmentContainer.innerHTML =
                        '<div class="no-assignments">üéâ No upcoming assignments for this worker.</div>';
                    return;
                }

                // Display SPFM assignment first (if exists)
                nextSpfmAssignment.forEach((assignment, index) => {
                    const card = document.createElement("div");
                    card.className = "assignment-card";
                    card.style.marginTop = index > 0 ? "20px" : "30px";

                    // Add header to distinguish SPFM vs Recovery
                    const assignmentHeader =
                        nextRecoveryRoute.length > 0
                            ? `<div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1rem;">
                             ü•ï SPFM Market Assignment
                           </div>`
                            : "";

                    card.innerHTML = `
                      ${assignmentHeader}
              <div class="market-section">
                <h2>${assignment.market} ‚Äì ${assignment.date}</h2>
                <p><strong>Time:</strong> ${assignment.startTime} ‚Äì ${assignment.endTime}</p>
                <p><strong>Pickup Amount:</strong> ${assignment.pickupAmount || assignment["pickupAmount "] || "TBD"}</p>
                <p><strong>Address:</strong> ${assignment.marketAddress}
                  <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(assignment.marketAddress)}"
                     target="_blank" class="directions-btn">üìç Get Directions</a>
                </p>
                ${
                    assignment.dropOffAddress &&
                    assignment.dropOffAddress.trim() !== "" &&
                    assignment.dropOffAddress.trim().toUpperCase() !== "TBD"
                        ? `
                    <p><strong>Full Route:</strong>
                        <a href="https://www.google.com/maps/dir/${encodeURIComponent(assignment.marketAddress)}/${encodeURIComponent(assignment.dropOffAddress.trim())}"
                           target="_blank" class="directions-btn">üó∫Ô∏è Market to Drop-off Route</a>
                    </p>
                `
                        : ""
                }

                <div class="team-info-header">
                  <div>
                    <h3>üë• Team</h3>
                    ${assignment.worker1 ? `<span class="team-member">${getWorkerEmoji(assignment.worker1)} ${assignment.worker1}</span>` : ""}
                    ${assignment.worker2 ? `<span class="team-member">${getWorkerEmoji(assignment.worker2)} ${assignment.worker2}</span>` : ""}
                    ${assignment.worker3 ? `<span class="team-member">${getWorkerEmoji(assignment.worker3)} ${assignment.worker3}</span>` : ""}
                  </div>
                  <div>
                    <h3>üöê Vans</h3>
                    ${assignment.van1 ? `<span class="van-badge">${vanIcons[assignment.van1]} ${assignment.van1}</span>` : ""}
                    ${assignment.van2 ? `<span class="van-badge">${vanIcons[assignment.van2]} ${assignment.van2}</span>` : ""}
                    ${assignment.van3 ? `<span class="van-badge">${vanIcons[assignment.van3]} ${assignment.van3}</span>` : ""}
                  </div>
                </div>
              </div>

              <div class="flow-section">
                <div class="step-section">
                  <div class="step-header">
                    <span class="step-number">1</span>
                    <h3>üì¶ Materials</h3>
                  </div>
                  <div class="task-grid">
                    <div class="task-column">
                      <div class="task-header">üìÇ Office Materials</div>
                      ${assignment.materials_office
                          .split(",")
                          .map((item) => item.trim())
                          .sort()
                          .map(
                              (item) => `
                        <div class="task-item"><div class="task-checkbox"></div><div class="task-text">${item}</div></div>
                      `,
                          )
                          .join("")}
                    </div>
                    <div class="task-column">
                      <div class="task-header">üèïÔ∏è Storage Materials</div>
                      ${assignment.materials_storage
                          .split(",")
                          .map((item) => item.trim())
                          .sort()
                          .map(
                              (item) => `
                        <div class="task-item"><div class="task-checkbox"></div><div class="task-text">${item}</div></div>
                      `,
                          )
                          .join("")}
                    </div>
                  </div>
                </div>

                <div class="flow-arrow">‚¨áÔ∏è</div>

                <div class="step-section">
                  <div class="step-header">
                    <span class="step-number">2</span>
                    <h3>üè™ At Market</h3>
                  </div>
                  <div class="single-column">
                    ${assignment.atMarket
                        .split(",")
                        .map((item) => item.trim())
                        .map(
                            (item) => `
                      <div class="task-item"><div class="task-checkbox"></div><div class="task-text">${item}</div></div>
                    `,
                        )
                        .join("")}
                  </div>
                </div>

                <div class="flow-arrow">‚¨áÔ∏è</div>

                <div class="step-section">
                  <div class="step-header">
                    <span class="step-number">3</span>
                    <h3>üöö Drop-off</h3>
                  </div>
                  <div class="single-column">
                    ${
                        assignment.dropOff &&
                        assignment.dropOff.trim() &&
                        assignment.dropOff !== "TBD"
                            ? `<p><strong>${assignment.dropOff}</strong></p>
                       <p><strong>Address:</strong> ${assignment.dropOffAddress}
                         ${
                             assignment.dropOffAddress &&
                             assignment.dropOffAddress.trim() !== "" &&
                             assignment.dropOffAddress.trim() !== "TBD"
                                 ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(assignment.dropOffAddress.trim())}"
                              target="_blank" class="directions-btn">üìç Get Directions</a>`
                                 : ""
                         }
                       </p>`
                            : "<p><strong>Drop-off location TBD</strong></p>"
                    }
                  </div>
                </div>

                <div class="flow-arrow">‚¨áÔ∏è</div>

                <div class="step-section">
                  <div class="step-header">
                    <span class="step-number">4</span>
                    <h3>üè¢ Back at Office</h3>
                  </div>
                  <div class="single-column">
                    ${assignment.backAtOffice
                        .split(",")
                        .map((item) => item.trim())
                        .map(
                            (item) => `
                      <div class="task-item"><div class="task-checkbox"></div><div class="task-text">${item}</div></div>
                    `,
                        )
                        .join("")}
                  </div>
                </div>
              </div>
            `;
                    card.dataset.routeId = assignment.routeId;
                    assignmentContainer.appendChild(card);
                });

                // Display Recovery route (if exists)
                nextRecoveryRoute.forEach((route, index) => {
                    const card = document.createElement("div");
                    card.className = "assignment-card";
                    card.style.marginTop = "20px";

                    // Create recovery route flow with calculated date
                    const routeDate =
                        getNextDateForDay(route["Recovery Routes"]) ||
                        route["Recovery Routes"];
                    const recoveryHeader = `<div style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1rem;">
                             üöó Recovery Route - ${routeDate}
                           </div>`;

                    // Build stops array from the route data
                    const stops = [];
                    for (let i = 1; i <= 7; i++) {
                        const stopName = route[`Stop ${i}`];
                        const stopAddress = route[`Addy ${i}`];
                        if (
                            stopName &&
                            stopName.trim() &&
                            stopName !== `Stop ${String.fromCharCode(64 + i)}`
                        ) {
                            stops.push({
                                name: stopName,
                                address: stopAddress || "",
                            });
                        }
                    }

                    // Create Google Maps route URL for all stops
                    const allAddresses = stops
                        .filter((stop) => stop.address && stop.address.trim())
                        .map((stop) => encodeURIComponent(stop.address));

                    const fullRouteUrl =
                        allAddresses.length > 1
                            ? `https://www.google.com/maps/dir/${allAddresses.join("/")}`
                            : allAddresses.length === 1
                              ? `https://www.google.com/maps/search/?api=1&query=${allAddresses[0]}`
                              : "#";

                    // Build stops HTML
                    const stopsHtml = stops
                        .map((stop, index) => {
                            const directionUrl =
                                stop.address && stop.address.trim()
                                    ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.address)}`
                                    : "#";

                            return `
                            <div class="step-section">
                                <div class="step-header">
                                    <span class="step-number">${index + 1}</span>
                                    <h3>üìç ${stop.name}</h3>
                                </div>
                                <div class="single-column">
                                    ${
                                        stop.address
                                            ? `
                                        <p><strong>Address:</strong> ${stop.address}
                                            <a href="${directionUrl}" target="_blank" class="directions-btn">üìç Get Directions</a>
                                        </p>
                                    `
                                            : `<p><em>Address not specified</em></p>`
                                    }
                                </div>
                            </div>
                            ${index < stops.length - 1 ? '<div class="flow-arrow">‚¨áÔ∏è</div>' : ""}
                        `;
                        })
                        .join("");

                    card.innerHTML = `
                        ${recoveryHeader}
                        <div class="market-section">
                            <h2>üöó Recovery Route</h2>
                            <p><strong>Worker:</strong> ${getWorkerEmoji(route.Worker)} ${route.Worker}</p>
                            <p><strong>Date:</strong> ${routeDate}</p>
                            ${
                                stops.length > 1
                                    ? `
                                <p><strong>Full Route:</strong>
                                    <a href="${fullRouteUrl}" target="_blank" class="directions-btn">üó∫Ô∏è Open Full Route in Maps</a>
                                </p>
                            `
                                    : ""
                            }
                        </div>
                        <div class="flow-section">
                            ${stopsHtml}
                        </div>
                    `;

                    assignmentContainer.appendChild(card);
                });

                // Make checkboxes interactive (visual only - no saving)
                document.querySelectorAll(".task-checkbox").forEach((box) => {
                    box.addEventListener("click", () => {
                        // Simply toggle the visual state (checkmark appears/disappears)
                        box.classList.toggle("checked");

                        // Log for debugging (no actual saving occurs)
                        const taskText =
                            box.nextElementSibling?.textContent?.trim();
                        console.log(`‚úì Checkbox toggled: ${taskText}`);
                    });
                });
            }

            // ========================================
            // UTILITY FUNCTIONS
            // ========================================
            // Helper functions for formatting and display

            // Calculate next occurrence of a given day of week
            function getNextDateForDay(dayName) {
                const today = new Date();
                const dayNames = [
                    "sunday",
                    "monday",
                    "tuesday",
                    "wednesday",
                    "thursday",
                    "friday",
                    "saturday",
                ];
                const targetDay = dayNames.indexOf(dayName.toLowerCase());

                if (targetDay === -1) return null;

                const daysUntilTarget = (targetDay - today.getDay() + 7) % 7;
                const nextDate = new Date(today);
                nextDate.setDate(
                    today.getDate() +
                        (daysUntilTarget === 0 ? 7 : daysUntilTarget),
                );

                return nextDate.toLocaleDateString("en-US", {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                });
            }

            // Get Date object for sorting
            function getNextDateObjectForDay(dayName) {
                const today = new Date();
                const dayNames = [
                    "sunday",
                    "monday",
                    "tuesday",
                    "wednesday",
                    "thursday",
                    "friday",
                    "saturday",
                ];
                const targetDay = dayNames.indexOf(dayName.toLowerCase());

                if (targetDay === -1) return null;

                const daysUntilTarget = (targetDay - today.getDay() + 7) % 7;
                const nextDate = new Date(today);
                nextDate.setDate(
                    today.getDate() +
                        (daysUntilTarget === 0 ? 7 : daysUntilTarget),
                );

                return nextDate;
            }

            // Handle recovery route selection
            function selectRecoveryRoute(route, el) {
                // Update visual selection
                document
                    .querySelectorAll(".date-card")
                    .forEach((card) => card.classList.remove("selected"));
                el.classList.add("selected");

                const assignmentContainer = document.getElementById(
                    "assignmentContainer",
                );
                assignmentContainer.innerHTML = "";

                // Create recovery route display
                const card = document.createElement("div");
                card.className = "assignment-card";
                card.style.marginTop = "30px";

                const routeDate =
                    route.calculatedDate || route["Recovery Routes"];
                const recoveryHeader = `<div style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1rem;">
                         üöó Recovery Route - ${routeDate}
                       </div>`;

                // Build stops array
                const stops = [];
                for (let i = 1; i <= 7; i++) {
                    const stopName = route[`Stop ${i}`];
                    const stopAddress = route[`Addy ${i}`];
                    if (
                        stopName &&
                        stopName.trim() &&
                        stopName !== `Stop ${String.fromCharCode(64 + i)}`
                    ) {
                        stops.push({
                            name: stopName,
                            address: stopAddress || "",
                        });
                    }
                }

                // Create Google Maps URLs
                const allAddresses = stops
                    .filter((stop) => stop.address && stop.address.trim())
                    .map((stop) => encodeURIComponent(stop.address));

                const fullRouteUrl =
                    allAddresses.length > 1
                        ? `https://www.google.com/maps/dir/${allAddresses.join("/")}`
                        : allAddresses.length === 1
                          ? `https://www.google.com/maps/search/?api=1&query=${allAddresses[0]}`
                          : "#";

                // Build stops HTML
                const stopsHtml = stops
                    .map((stop, index) => {
                        const directionUrl =
                            stop.address && stop.address.trim()
                                ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.address)}`
                                : "#";

                        return `
                        <div class="step-section">
                            <div class="step-header">
                                <span class="step-number">${index + 1}</span>
                                <h3>üìç ${stop.name}</h3>
                            </div>
                            <div class="single-column">
                                ${
                                    stop.address
                                        ? `<p><strong>Address:</strong> ${stop.address}
                                        <a href="${directionUrl}" target="_blank" class="directions-btn">üìç Get Directions</a>
                                       </p>`
                                        : `<p><em>Address not specified</em></p>`
                                }
                            </div>
                        </div>
                        ${index < stops.length - 1 ? '<div class="flow-arrow">‚¨áÔ∏è</div>' : ""}
                    `;
                    })
                    .join("");

                card.innerHTML = `
                    ${recoveryHeader}
                    <div class="market-section">
                        <h2>üöó Recovery Route</h2>
                        <p><strong>Worker:</strong> ${getWorkerEmoji(route.Worker)} ${route.Worker}</p>
                        <p><strong>Date:</strong> ${routeDate}</p>
                        ${
                            stops.length > 1
                                ? `<p><strong>Full Route:</strong>
                                <a href="${fullRouteUrl}" target="_blank" class="directions-btn">üó∫Ô∏è Open Full Route in Maps</a>
                               </p>`
                                : ""
                        }
                    </div>
                    <div class="flow-section">
                        ${stopsHtml}
                    </div>
                `;

                assignmentContainer.appendChild(card);
            }

            function getWorkerEmoji(workerName) {
                // Return appropriate emoji for worker, or default person icon
                if (!workerName || workerName.trim() === "") return "üë§";

                // Check for volunteers (case-insensitive)
                if (workerName.trim().toLowerCase().includes("volunteer")) {
                    return "üë§";
                }

                const workerIcon = Object.keys(workerIcons).find(
                    (key) =>
                        key.toLowerCase() === workerName.trim().toLowerCase(),
                );
                return workerIcon ? workerIcons[workerIcon] : "üë§";
            }

            function formatDate(dateString) {
                // Format dates consistently for display
                // If already formatted (like "Sunday, August 3, 2025"), return as-is
                if (dateString.includes(",")) {
                    return dateString;
                }
                // Otherwise, format from ISO date to readable format
                const date = new Date(dateString);
                const options = {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                };
                return date.toLocaleDateString("en-US", options);
            }

            // ========================================
            // RECOVERY ROUTES DATA FETCHING
            // ========================================
            // Fetch recovery routes from Recovery sheet tab

            async function fetchRecoveryData() {
                try {
                    // Try to fetch recovery routes from the "Recovery" sheet tab
                    const recoveryRange = "Recovery!A:P";
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${recoveryRange}?key=${API_KEY}`;
                    console.log("üöó Attempting to fetch recovery routes...");

                    const response = await fetch(url);
                    if (!response.ok) {
                        console.log(
                            "Recovery tab not found - skipping recovery routes",
                        );
                        return;
                    }

                    const result = await response.json();

                    if (!result.values || result.values.length < 2) {
                        console.log(
                            "Recovery tab is empty - skipping recovery routes",
                        );
                        return;
                    }

                    // Convert recovery rows to JavaScript objects
                    const headers = result.values[0];
                    recoveryData = result.values.slice(1).map((row) => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || "";
                        });
                        return obj;
                    });

                    console.log(
                        `‚úÖ Loaded ${recoveryData.length} recovery routes`,
                    );
                } catch (error) {
                    console.log(
                        "Recovery data not available (this is optional):",
                        error,
                    );
                    // Don't show error message - recovery is an optional feature
                }
            }

            // ========================================
            // INVENTORY DATA FETCHING
            // ========================================
            // Fetch box inventory from separate sheet tab (optional feature)

            async function fetchInventoryData() {
                try {
                    // Try to fetch box inventory from the "Inventory" sheet tab
                    const inventoryRange = "Inventory!A:Z";
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${inventoryRange}?key=${API_KEY}`;
                    console.log("üì¶ Attempting to fetch inventory data...");

                    const response = await fetch(url);
                    if (!response.ok) {
                        console.log(
                            "Inventory tab not found - skipping inventory display",
                        );
                        return;
                    }

                    const result = await response.json();

                    if (!result.values || result.values.length < 2) {
                        console.log(
                            "Inventory tab is empty - skipping inventory display",
                        );
                        return;
                    }

                    // Convert inventory rows to JavaScript objects
                    const headers = result.values[0];
                    inventoryData = result.values.slice(1).map((row) => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || "";
                        });
                        return obj;
                    });

                    console.log(
                        `‚úÖ Loaded ${inventoryData.length} inventory items`,
                    );
                    renderInventory(); // Display the inventory box
                } catch (error) {
                    console.log(
                        "Inventory data not available (this is optional):",
                        error,
                    );
                    // Don't show error message - inventory is an optional feature
                }
            }

            // ========================================
            // INVENTORY DISPLAY
            // ========================================
            // Shows current box inventory if available

            function renderInventory() {
                if (inventoryData.length === 0) return; // Skip if no inventory data

                const inventoryContent =
                    document.getElementById("inventoryContent");
                const inventoryBox = document.getElementById("inventoryBox");

                // Find box inventory items (Large/Small boxes)
                const boxItems = inventoryData.filter((item) => {
                    const firstColumn = Object.values(item)[0];
                    return (
                        firstColumn &&
                        (firstColumn.includes("Large") ||
                            firstColumn.includes("Small"))
                    );
                });

                // Find verification date entry
                const verifiedItem = inventoryData.find((item) => {
                    const firstColumn = Object.values(item)[0];
                    return firstColumn && firstColumn.includes("Verified on");
                });

                // Create HTML for box inventory items
                const boxesHtml = boxItems
                    .map((item) => {
                        const values = Object.values(item);
                        const boxType = values[0] || "Unknown";
                        const quantity = values[1] || "0";

                        return `
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${boxType} Boxes</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${quantity}</div>
                        </div>
                    `;
                    })
                    .join("");

                // Create HTML for verification date (if available)
                const verificationHtml = verifiedItem
                    ? `
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 5px;">üìÖ Last Verified</div>
                        <div style="font-size: 1.1rem; font-weight: bold;">${Object.values(verifiedItem)[1]}</div>
                    </div>
                `
                    : "";

                // Display the inventory box with current data
                inventoryContent.innerHTML = boxesHtml + verificationHtml;
                inventoryBox.style.display = "block"; // Make inventory visible
            }

            // ========================================
            // PRINT FUNCTIONALITY
            // ========================================
            // Creates printer-friendly version of selected assignment

            function printAssignment() {
                const assignmentContainer = document.getElementById(
                    "assignmentContainer",
                );

                if (!assignmentContainer.innerHTML.trim()) {
                    alert(
                        "Please select a worker or date first to print their assignment.",
                    );
                    return;
                }

                // Create print-friendly title based on current selection
                const selectedWorker = document.querySelector(
                    ".worker-card.selected",
                );
                const selectedDate = document.querySelector(
                    ".date-card.selected",
                );

                let printTitle = "SPFM Market Recovery Routes";
                if (selectedWorker) {
                    printTitle += " - " + selectedWorker.textContent.trim();
                } else if (selectedDate) {
                    const dateText = selectedDate
                        .querySelector("h3")
                        .textContent.replace("üìÖ ", "");
                    printTitle += " - " + dateText;
                }

                // Temporarily update header for printing
                const originalHeaderContent =
                    document.querySelector(".header p").innerHTML;
                document.querySelector(".header p").innerHTML = printTitle;

                // Trigger browser's print dialog (creates PDF or sends to printer)
                window.print();

                // Restore original header after brief delay
                setTimeout(() => {
                    document.querySelector(".header p").innerHTML =
                        originalHeaderContent;
                }, 100);
            }

            // ========================================
            // FINAL INITIALIZATION
            // ========================================
            // Start the application by loading data from Google Sheets
            fetchSheetData();
        </script>

        <!--
            ========================================
            GOOGLE API SCRIPTS
            ========================================
            These load Google's official libraries for:
            1. Reading Google Sheets data (apis.google.com)
            2. Handling user sign-in (accounts.google.com)

            Both connect directly to Google - no third-party servers involved
        -->
        <script
            async
            defer
            src="https://apis.google.com/js/api.js"
            onload="gapiLoaded()"
        ></script>
        <script
            async
            defer
            src="https://accounts.google.com/gsi/client"
            onload="gsiLoaded()"
        ></script>
    </body>
</html>
